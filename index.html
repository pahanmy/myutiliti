<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>myutiliti - Pengurusan Bil Sekolah (Supabase)</title>
    <!-- Memuatkan Tailwind CSS untuk penggayaan -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuatkan font Inter dari Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Memuatkan Pustaka Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .toggle-checkbox:checked + .toggle-label { background-color: #4F46E5; }
        .dot { transition: transform 0.3s ease-in-out; }
        .toggle-checkbox:checked ~ .dot { transform: translateX(1.5rem); }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        /* Penggayaan untuk penunjuk memuat (loading spinner) */
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4F46E5;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #loading-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <div id="loading-overlay" class="hidden">
        <div class="loader"></div>
    </div>

    <div class="w-full max-w-7xl mx-auto">
        <header class="text-center mb-8 relative">
            <h1 class="text-4xl font-bold text-indigo-700">myutiliti</h1>
            <button id="admin-login-button" class="absolute top-0 right-0 z-10 bg-white border border-slate-300 text-slate-600 font-semibold py-2 px-4 rounded-lg hover:bg-slate-100 hover:border-slate-400 transition text-sm flex items-center gap-2 shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 8a6 6 0 11-12 0 6 6 0 0112 0zM7 8a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 017 8zM11.25 8.75a.75.75 0 00-1.5 0v1.5a.75.75 0 001.5 0v-1.5z" clip-rule="evenodd" /><path d="M5.5 12.5a3.5 3.5 0 107 0h-7z" /><path fill-rule="evenodd" d="M2 14.5a7.5 7.5 0 0110.606-6.812.75.75 0 01.623 1.244 6 6 0 00-9.458 5.568.75.75 0 01-1.244-.624A7.5 7.5 0 012 14.5zM17.5 9.5a.75.75 0 00-1.5 0v1.518a6.001 6.001 0 00-4.68 4.906.75.75 0 001.492.152 4.501 4.501 0 018.376 0 .75.75 0 001.492-.152A6.001 6.001 0 0017.5 11.018V9.5z" clip-rule="evenodd" /></svg>
                Admin
            </button>
        </header>

        <main class="bg-white p-6 sm:p-8 rounded-xl shadow-lg fade-in">
            <!-- BAHAGIAN 1: PENGESAHAN PENGGUNA BIASA -->
            <div id="verification-page">
                <div class="grid md:grid-cols-2 gap-12 items-center">
                    <div class="text-center md:text-left">
                        <h1 class="text-3xl font-bold text-slate-800">Selamat Datang ke myutiliti</h1>
                        <p class="text-slate-600 mt-4">Sistem Pengurusan Bil Utiliti Sekolah-sekolah Daerah Miri.</p>
                        <p class="text-sm text-slate-500 mt-2">Satu Projek Inovasi di bawah Unit ICT, Sektor Pengurusan.</p>
                    </div>
                    <div class="bg-slate-50 p-8 rounded-lg border border-slate-200">
                        <h2 class="text-2xl font-semibold mb-2 text-slate-800">Pendaftaran & Log Masuk</h2>
                        <p class="text-slate-600 mb-6">Sila masukkan Kod Sekolah rasmi untuk meneruskan.</p>
                        <div>
                            <input type="text" id="school-code-input" placeholder="Contoh: YCC4101" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                            <button id="verify-button" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300 mt-4">
                                Sahkan & Teruskan
                            </button>
                        </div>
                    </div>
                </div>
                <div id="school-status-section" class="mt-12">
                    <h3 class="text-xl font-semibold text-center mb-4">Status Pengisian Bil Sekolah</h3>
                    <div class="flex justify-center items-center gap-2 mb-4">
                        <label for="status-year-selector" class="font-medium">Tahun:</label>
                        <select id="status-year-selector" class="px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></select>
                    </div>
                    <div class="overflow-x-auto bg-white p-4 rounded-lg shadow-md border">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-50"></thead>
                            <tbody id="school-status-tbody"></tbody>
                        </table>
                    </div>
                    <p class="text-xs text-center text-slate-500 mt-2">Nota: Paparan di bawah adalah data yang disimpan dalam pangkalan data.</p>
                </div>
            </div>

            <!-- BAHAGIAN 2: PENETAPAN UTILITI -->
            <div id="setup-page" class="hidden">
                 <h2 class="text-2xl font-semibold mb-2">Penetapan Maklumat Utiliti</h2>
                <p class="text-slate-600 mb-6">Daftarkan semua akaun utiliti sekolah. Selepas ini, anda boleh mengemas kini maklumat ini di Paparan Utama.</p>
                <div id="utility-list" class="space-y-6"></div>
                <div class="mt-8 pt-6 border-t border-slate-200 flex justify-end">
                    <button id="save-setup-button" class="bg-green-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-300">Simpan & Teruskan</button>
                </div>
            </div>

            <!-- BAHAGIAN 3: PAPARAN UTAMA (DASHBOARD) PENGGUNA -->
            <div id="dashboard-page" class="hidden">
                 <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-2xl font-semibold">Paparan Utama</h2>
                        <p id="dashboard-school-code" class="text-slate-600 font-bold text-indigo-700"></p>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <label for="year-selector" class="font-medium">Tahun:</label>
                            <select id="year-selector" class="px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></select>
                        </div>
                        <button id="edit-settings-button" class="bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition">Ubah Tetapan</button>
                        <button id="logout-button" class="bg-red-100 text-red-700 font-semibold py-2 px-4 rounded-lg hover:bg-red-200 transition">Log Keluar</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-slate-50 p-5 rounded-xl border border-slate-200">
                        <h4 class="text-sm font-medium text-slate-500">Utiliti Aktif</h4>
                        <p id="summary-active-utilities" class="text-3xl font-bold text-indigo-700 mt-1">0</p>
                    </div>
                    <div class="bg-slate-50 p-5 rounded-xl border border-slate-200">
                        <h4 class="text-sm font-medium text-slate-500">Bil Belum Diisi (Tahun Ini)</h4>
                        <p id="summary-unfilled-bills" class="text-3xl font-bold text-orange-600 mt-1">0</p>
                    </div>
                    <div class="bg-slate-50 p-5 rounded-xl border border-slate-200">
                        <h4 id="summary-current-month-title" class="text-sm font-medium text-slate-500">Status Bulan Semasa</h4>
                        <div id="summary-current-month-status"></div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md border">
                    <h3 class="text-lg font-semibold p-4 border-b border-slate-200">Rekod Bil Bulanan</h3>
                    <div class="overflow-x-auto">
                        <div id="billing-table-container"></div>
                    </div>
                </div>
                <div class="mt-8 pt-6 border-t border-slate-200 flex justify-end">
                    <button id="save-bills-button" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300">Simpan Rekod Bil</button>
                </div>
            </div>

            <!-- BAHAGIAN 4: PAPARAN ADMIN - SENARAI SEKOLAH -->
            <div id="admin-dashboard-page" class="hidden">
                 <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                    <h2 class="text-2xl font-semibold">Paparan Admin - Senarai Sekolah</h2>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <label for="admin-month-selector" class="font-medium text-sm">Bulan:</label>
                            <select id="admin-month-selector" class="px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></select>
                        </div>
                        <div class="flex items-center gap-2">
                            <label for="admin-year-selector" class="font-medium text-sm">Tahun:</label>
                            <select id="admin-year-selector" class="px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></select>
                        </div>
                        <button id="add-school-button" class="bg-green-100 text-green-700 font-semibold py-2 px-4 rounded-lg hover:bg-green-200 transition">Tambah Sekolah</button>
                        <button id="print-form-button" class="bg-blue-100 text-blue-700 font-semibold py-2 px-4 rounded-lg hover:bg-blue-200 transition">Cetak Borang</button>
                        <button id="admin-logout-button" class="bg-red-100 text-red-700 font-semibold py-2 px-4 rounded-lg hover:bg-red-200 transition">Log Keluar Admin</button>
                    </div>
                </div>
                <div id="admin-school-list-container" class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-4 text-green-700 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                            Sekolah Selesai
                        </h3>
                        <div id="admin-completed-school-list" class="space-y-2"></div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-4 text-orange-700 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                            Sekolah Belum Selesai
                        </h3>
                        <div id="admin-incomplete-school-list" class="space-y-2"></div>
                    </div>
                </div>
                <div id="admin-summary-status-section" class="mt-12">
                    <h3 class="text-xl font-semibold text-center mb-4">Jadual Status Keseluruhan</h3>
                    <p class="text-center text-sm text-slate-500 mb-4">Klik pada mana-mana penanda status untuk melihat butiran.</p>
                    <div class="overflow-x-auto bg-white p-4 rounded-lg shadow-md border">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-50"></thead>
                            <tbody id="admin-summary-status-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- BAHAGIAN 5: PAPARAN ADMIN - SEMAKAN SEKOLAH -->
            <div id="admin-school-view-page" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-semibold">Semakan Bil Sekolah</h2>
                        <p id="admin-view-school-name" class="text-slate-600 font-bold text-indigo-700"></p>
                    </div>
                    <button id="back-to-admin-dashboard" class="bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition">&larr; Kembali ke Senarai</button>
                </div>
                <div class="overflow-x-auto"><div id="admin-billing-table-container"></div></div>
            </div>
        </main>
        
        <footer class="text-center mt-8 py-6 border-t border-slate-200 text-sm text-slate-500">
            <p>Dibangunkan oleh Pahan.</p>
            <p>Sertai perkembangan projek di <a href="https://t.me/mypahan" target="_blank" rel="noopener noreferrer" class="font-medium text-indigo-600 hover:underline">Telegram @mypahan</a>.</p>
        </footer>

        <div id="toast-notification" class="fixed bottom-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-xl opacity-0 translate-y-10 transition-all duration-300"></div>
    </div>

    <!-- Modal Log Masuk Admin -->
    <div id="admin-login-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center mb-6">Log Masuk Admin</h2>
            <div class="space-y-4">
                <div>
                    <label for="admin-password" class="block text-sm font-medium text-slate-700">Kata Laluan</label>
                    <input type="password" id="admin-password" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div id="admin-login-error" class="text-red-500 text-sm hidden">Kata laluan salah!</div>
                <div class="flex justify-end gap-4 pt-4">
                    <button id="cancel-admin-login" class="bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition">Batal</button>
                    <button id="submit-admin-login" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Log Masuk</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Butiran Bil (Admin) -->
    <div id="details-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl max-h-full overflow-y-auto">
            <div class="flex justify-between items-center mb-4 pb-4 border-b">
                <h2 id="details-modal-title" class="text-xl font-bold">Butiran Bil</h2>
                <button id="close-details-modal" class="text-slate-500 hover:text-slate-800 text-3xl font-bold leading-none">&times;</button>
            </div>
            <div id="details-modal-body" class="space-y-4"></div>
        </div>
    </div>
    
    <!-- Modal Tambah Sekolah -->
    <div id="add-school-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center mb-6">Tambah Sekolah Baharu</h2>
            <div class="space-y-4">
                <div>
                    <label for="new-school-code" class="block text-sm font-medium text-slate-700">Kod Sekolah</label>
                    <input type="text" id="new-school-code" placeholder="Cth: YBB4106" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="new-school-name" class="block text-sm font-medium text-slate-700">Nama Sekolah</label>
                    <input type="text" id="new-school-name" placeholder="Cth: SK BARU MIRI" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div id="add-school-error" class="text-red-500 text-sm hidden"></div>
                <div class="flex justify-end gap-4 pt-4">
                    <button id="cancel-add-school" class="bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition">Batal</button>
                    <button id="submit-add-school" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition">Simpan</button>
                </div>
            </div>
        </div>
    </div>


<script type="module">
    // === Sambungan ke Supabase ===
    const SUPABASE_URL = 'https://shtptijtnnzpyznrfyqp.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNodHB0aWp0bm56cHl6bnJmeXFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NzkyOTEsImV4cCI6MjA3NDQ1NTI5MX0.uV_thIwYbtpnTZ4Kh4pYpsmhafHYQQguzITZ1Ry2yLc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // === MULA KOD APLIKASI UTAMA ===
    document.addEventListener('DOMContentLoaded', () => {
        // Rujukan elemen
        const loadingOverlay = document.getElementById('loading-overlay');
        const pages = {
            verification: document.getElementById('verification-page'),
            setup: document.getElementById('setup-page'),
            dashboard: document.getElementById('dashboard-page'),
            adminDashboard: document.getElementById('admin-dashboard-page'),
            adminSchoolView: document.getElementById('admin-school-view-page'),
        };
        const schoolCodeInput = document.getElementById('school-code-input');
        const verifyButton = document.getElementById('verify-button');
        const saveSetupButton = document.getElementById('save-setup-button');
        const dashboardSchoolCode = document.getElementById('dashboard-school-code');
        const yearSelector = document.getElementById('year-selector');
        const statusYearSelector = document.getElementById('status-year-selector');
        const billingTableContainer = document.getElementById('billing-table-container');
        const saveBillsButton = document.getElementById('save-bills-button');
        const editSettingsButton = document.getElementById('edit-settings-button');
        const logoutButton = document.getElementById('logout-button');
        const adminLoginButton = document.getElementById('admin-login-button');
        const adminLogoutButton = document.getElementById('admin-logout-button');
        const adminSchoolListContainer = document.getElementById('admin-school-list-container');
        const adminViewSchoolName = document.getElementById('admin-view-school-name');
        const adminBillingTableContainer = document.getElementById('admin-billing-table-container');
        const backToAdminDashboard = document.getElementById('back-to-admin-dashboard');
        const toast = document.getElementById('toast-notification');
        const schoolStatusTbody = document.getElementById('school-status-tbody');
        const adminMonthSelector = document.getElementById('admin-month-selector');
        const adminYearSelector = document.getElementById('admin-year-selector');
        const adminSummaryStatusTbody = document.getElementById('admin-summary-status-tbody');
        const printFormButton = document.getElementById('print-form-button');
        const addSchoolButton = document.getElementById('add-school-button');
        // Modal Admin Login
        const adminLoginModal = document.getElementById('admin-login-modal');
        const adminPasswordInput = document.getElementById('admin-password');
        const cancelAdminLogin = document.getElementById('cancel-admin-login');
        const submitAdminLogin = document.getElementById('submit-admin-login');
        const adminLoginError = document.getElementById('admin-login-error');
        // Modal Butiran
        const detailsModal = document.getElementById('details-modal');
        const detailsModalTitle = document.getElementById('details-modal-title');
        const detailsModalBody = document.getElementById('details-modal-body');
        const closeDetailsModal = document.getElementById('close-details-modal');
        // Modal Tambah Sekolah
        const addSchoolModal = document.getElementById('add-school-modal');
        const newSchoolCodeInput = document.getElementById('new-school-code');
        const newSchoolNameInput = document.getElementById('new-school-name');
        const addSchoolError = document.getElementById('add-school-error');
        const cancelAddSchool = document.getElementById('cancel-add-school');
        const submitAddSchool = document.getElementById('submit-add-school');

        const UTILITIES = [ { id: 'sesco', name: 'SESCO' }, { id: 'swb', name: 'Sarawak Water' }, { id: 'tm_phone', name: 'TM - Telefon' }, { id: 'tm_internet', name: 'TM - Internet' }];
        const MONTHS = ['Januari', 'Februari', 'Mac', 'April', 'Mei', 'Jun', 'Julai', 'Ogos', 'September', 'Oktober', 'November', 'Disember'];
        let SCHOOL_DB = {};
        let ALL_SCHOOL_DATA = []; // Cache untuk data semua sekolah

        // --- Fungsi Bantuan ---
        const showLoader = () => loadingOverlay.classList.remove('hidden');
        const hideLoader = () => loadingOverlay.classList.add('hidden');
        const showPage = (pageName) => { Object.values(pages).forEach(p => p.classList.add('hidden')); pages[pageName].classList.remove('hidden'); };
        const showToast = (message, isError = false) => {
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 text-white py-3 px-6 rounded-lg shadow-xl transition-all duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-10'); }, 3000);
        };
        const populateYearSelectors = (selectors) => {
            selectors.forEach(selector => {
                if (!selector) return;
                selector.innerHTML = '';
                const currentYear = new Date().getFullYear();
                for (let i = currentYear + 1; i >= currentYear - 5; i--) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    if (i === currentYear) option.selected = true;
                    selector.appendChild(option);
                }
            });
        };

        // --- Fungsi Data Supabase ---
        const loadSchoolDB = async () => {
            const { data, error } = await supabaseClient.from('schools').select('code, name');
            if (error) {
                console.error("Gagal memuatkan senarai sekolah:", error.message);
                throw new Error("Tidak dapat memuat turun senarai sekolah.");
            }
            SCHOOL_DB = data.reduce((acc, school) => { acc[school.code] = school.name; return acc; }, {});
        };
        const getSchoolData = async (code) => {
            const { data, error } = await supabaseClient.from('utilities').select('settings, bills').eq('school_code', code).single();
            if (error && error.code !== 'PGRST116') throw error; // Abaikan ralat 'No rows found'
            return data || { settings: [], bills: {} };
        };
        const getAllSchoolData = async () => {
            const { data, error } = await supabaseClient.from('utilities').select('school_code, settings, bills');
            if(error) {
                console.error("Gagal memuatkan semua data sekolah:", error);
                throw new Error("Gagal memuatkan data status sekolah.");
            }
            ALL_SCHOOL_DATA = data;
            return data;
        };
        const saveData = async (code, dataObject) => {
            showLoader();
            try {
                const { error } = await supabaseClient.from('utilities').upsert({ school_code: code, ...dataObject }, { onConflict: 'school_code' });
                if (error) throw error;
                return true;
            } catch (error) {
                console.error("Gagal menyimpan data:", error.message);
                showToast("Gagal menyimpan data. Sila cuba lagi.", true);
                return false;
            } finally {
                hideLoader();
            }
        };

        // --- Logik Render UI ---
        const renderSetupPage = async () => {
            const utilityListContainer = document.getElementById('utility-list');
            utilityListContainer.innerHTML = '';
            const schoolCode = sessionStorage.getItem('myutiliti_currentSchoolCode');
            
            showLoader();
            const { settings: savedUtilities } = await getSchoolData(schoolCode);
            hideLoader();

            UTILITIES.forEach(utility => {
                const utilityDiv = document.createElement('div');
                utilityDiv.className = 'p-4 border border-slate-200 rounded-lg';
                utilityDiv.innerHTML = `<div class="flex justify-between items-center"><h3 class="text-lg font-semibold text-slate-700">${utility.name}</h3><button data-utility-id="${utility.id}" class="add-account-btn bg-indigo-100 text-indigo-700 font-semibold text-sm py-1 px-3 rounded-full hover:bg-indigo-200 transition">+ Tambah Akaun</button></div><div id="${utility.id}-accounts-container" class="mt-4 space-y-3"></div>`;
                utilityListContainer.appendChild(utilityDiv);
                
                const accountsForUtility = savedUtilities.filter(u => u.utilityId === utility.id);
                if (accountsForUtility.length > 0) {
                    accountsForUtility.forEach(acc => addAccountRow(utility.id, acc.accountNumber, acc.isActive));
                } else {
                    addAccountRow(utility.id);
                }
            });
        };
        
        const addAccountRow = (utilityId, accountNumber = '', isActive = true) => {
            const container = document.getElementById(`${utilityId}-accounts-container`);
            if (!container) return;
            const accountRow = document.createElement('div');
            accountRow.className = 'flex items-center gap-3 p-3 bg-slate-50 rounded-md';
            accountRow.innerHTML = `<input type="text" value="${accountNumber}" placeholder="No. Akaun" class="account-number-input flex-grow px-3 py-2 border border-slate-300 rounded-md focus:ring-1 focus:ring-indigo-500"><label class="flex items-center cursor-pointer"><div class="relative"><input type="checkbox" class="sr-only toggle-checkbox account-active-checkbox" ${isActive ? 'checked' : ''}><div class="block bg-slate-300 w-12 h-6 rounded-full toggle-label transition"></div><div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full"></div></div><span class="ml-3 text-sm font-medium text-slate-600">Aktif</span></label><button class="remove-account-btn text-slate-400 hover:text-red-500 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>`;
            container.appendChild(accountRow);
            
            const checkbox = accountRow.querySelector('.toggle-checkbox');
            checkbox.addEventListener('change', (e) => {
                const dot = e.target.closest('.relative').querySelector('.dot');
                const labelBg = e.target.closest('.relative').querySelector('.toggle-label');
                if (e.target.checked) {
                    dot.style.transform = 'translateX(1.5rem)';
                    labelBg.classList.replace('bg-slate-300', 'bg-indigo-600');
                } else {
                    dot.style.transform = 'translateX(0)';
                    labelBg.classList.replace('bg-indigo-600', 'bg-slate-300');
                }
            });
            checkbox.dispatchEvent(new Event('change')); // Trigger initial style
        };

        const renderDashboard = async () => {
            showLoader();
            const schoolCode = sessionStorage.getItem('myutiliti_currentSchoolCode');
            const schoolName = SCHOOL_DB[schoolCode] || schoolCode;
            const { settings: utilities, bills } = await getSchoolData(schoolCode);
            const selectedYear = yearSelector.value;
            
            dashboardSchoolCode.innerHTML = `${schoolName} <span class="text-sm font-normal text-slate-500">(${schoolCode})</span>`;

            // Kad Ringkasan
            const activeUtilities = utilities.filter(u => u.isActive);
            document.getElementById('summary-active-utilities').textContent = activeUtilities.length;
            
            let unfilledBillsCount = 0;
            const currentYear = new Date().getFullYear().toString();
            activeUtilities.forEach(util => {
                for (let i = 0; i < 12; i++) {
                    const billKey = `${currentYear}-${util.utilityId}-${util.accountNumber}`;
                    const billData = (bills[billKey] && bills[billKey][i]) ? bills[billKey][i] : {};
                    if (!billData.amount || parseFloat(billData.amount) <= 0) {
                        unfilledBillsCount++;
                    }
                }
            });
            document.getElementById('summary-unfilled-bills').textContent = unfilledBillsCount;

            const now = new Date();
            const currentMonthIndex = now.getMonth();
            let pendingUtilities = [];
            let allCurrentMonthBillsFilled = activeUtilities.length > 0;
            if(activeUtilities.length === 0) allCurrentMonthBillsFilled = true;

            activeUtilities.forEach(util => {
                const billKey = `${currentYear}-${util.utilityId}-${util.accountNumber}`;
                const billData = (bills[billKey] && bills[billKey][currentMonthIndex]) ? bills[billKey][currentMonthIndex] : {};
                if (!billData.amount || parseFloat(billData.amount) <= 0) {
                    allCurrentMonthBillsFilled = false;
                    pendingUtilities.push(UTILITIES.find(u => u.id === util.utilityId).name);
                }
            });
            
            document.getElementById('summary-current-month-title').textContent = `Status Bulan Semasa (${MONTHS[currentMonthIndex]})`;
            const statusEl = document.getElementById('summary-current-month-status');
            if (allCurrentMonthBillsFilled) {
                statusEl.innerHTML = `<div class="flex items-center gap-2 mt-2"><span class="flex-shrink-0 bg-green-100 text-green-700 rounded-full p-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg></span><p class="text-lg font-bold text-green-700">Selesai</p></div><p class="text-xs text-slate-500 mt-1">Semua bil untuk bulan ini telah diisi.</p>`;
            } else {
                statusEl.innerHTML = `<div class="flex items-center gap-2 mt-2"><span class="flex-shrink-0 bg-orange-100 text-orange-700 rounded-full p-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></span><p class="text-lg font-bold text-orange-700">Belum Selesai</p></div><p class="text-xs text-slate-500 mt-1">Sila isi bil untuk: ${[...new Set(pendingUtilities)].join(', ')}.</p>`;
            }
            
            // Jadual Bil
            if (utilities.length === 0) {
                billingTableContainer.innerHTML = `<p class="p-4 text-center text-slate-500">Tiada data utiliti. Sila ke 'Ubah Tetapan'.</p>`;
                hideLoader();
                return;
            }

            let tableHTML = `<table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-100"><tr><th scope="col" class="px-4 py-3 sticky left-0 bg-slate-100 z-10 min-w-[120px]">Utiliti</th><th scope="col" class="px-4 py-3 min-w-[150px]">No. Akaun</th><th scope="col" class="px-4 py-3">Status</th>${MONTHS.map(m => `<th scope="col" class="px-4 py-3 min-w-[220px]">${m}</th>`).join('')}</tr></thead><tbody>`;
            utilities.forEach((util) => {
                const utilityInfo = UTILITIES.find(u => u.id === util.utilityId);
                tableHTML += `<tr class="bg-white border-b hover:bg-slate-50"><td class="px-4 py-3 font-medium text-slate-900 sticky left-0 bg-white z-10">${utilityInfo.name}</td><td class="px-4 py-3 font-mono">${util.accountNumber}</td><td class="px-4 py-3"><span class="px-2 py-1 text-xs font-medium rounded-full ${util.isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${util.isActive ? 'Aktif' : 'Tidak Aktif'}</span></td>${MONTHS.map((m, i) => {
                    const billKey = `${selectedYear}-${util.utilityId}-${util.accountNumber}`;
                    const billData = (bills[billKey] && bills[billKey][i]) ? bills[billKey][i] : { amount: '', file: '' };
                    return `<td class="px-2 py-2"><div class="flex items-center gap-1.5"><input type="number" step="0.01" min="0" class="w-24 p-2 border rounded-md bill-input bg-slate-50" placeholder="RM" data-key="${billKey}" data-month-index="${i}" value="${billData.amount || ''}" ${!util.isActive ? 'disabled' : ''}><label class="cursor-pointer" title="${billData.file ? 'Bil Telah Dimuat Naik' : 'Muat Naik Bil'}"><input type="file" class="hidden file-input" data-key="${billKey}" data-month-index="${i}" ${!util.isActive ? 'disabled' : ''}>${billData.file ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>` : `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400 hover:text-indigo-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>`}</label><span class="text-xs text-slate-500 truncate max-w-[60px] file-name-display" title="${billData.file || ''}">${billData.file || ''}</span>${billData.file ? `<button class="clear-file-btn text-slate-400 hover:text-red-500" data-key="${billKey}" data-month-index="${i}" title="Padam Fail">&#x2715;</button>` : ''}</div></td>`
                }).join('')}</tr>`;
            });
            tableHTML += `</tbody></table>`;
            billingTableContainer.innerHTML = tableHTML;
            hideLoader();
        };

        const renderSchoolStatusTable = async (targetTbody, year) => {
            showLoader();
            try {
                // Fetch latest data if cache is empty
                if (ALL_SCHOOL_DATA.length === 0) await getAllSchoolData();

                let bodyHTML = '';
                Object.keys(SCHOOL_DB).sort((a,b) => SCHOOL_DB[a].localeCompare(SCHOOL_DB[b])).forEach(schoolCode => {
                    const schoolData = ALL_SCHOOL_DATA.find(d => d.school_code === schoolCode);
                    const utilities = schoolData?.settings || [];
                    const bills = schoolData?.bills || {};
                    const activeUtilities = utilities.filter(u => u.isActive);
                    
                    bodyHTML += `<tr><td class="px-4 py-3 font-medium text-slate-900">${SCHOOL_DB[schoolCode]}</td>`;
                    
                    if (activeUtilities.length === 0) {
                        bodyHTML += `<td colspan="12" class="px-4 py-3 text-center text-slate-400">Tiada utiliti aktif</td>`;
                    } else {
                        MONTHS.forEach((month, index) => {
                            let isMonthComplete = true;
                            for (const util of activeUtilities) {
                                const billKey = `${year}-${util.utilityId}-${util.accountNumber}`;
                                const billData = (bills[billKey] && bills[billKey][index]) ? bills[billKey][index] : { amount: '' };
                                if (!billData.amount || billData.amount <= 0) {
                                    isMonthComplete = false;
                                    break;
                                }
                            }
                            const colorClass = isMonthComplete ? 'bg-green-500' : 'bg-red-500';
                            bodyHTML += `<td class="p-2 text-center"><span class="status-dot inline-block w-4 h-4 rounded-full cursor-pointer hover:ring-2 hover:ring-offset-1 hover:ring-blue-400 ${colorClass}" title="Lihat Butiran" data-school-code="${schoolCode}" data-school-name="${SCHOOL_DB[schoolCode]}" data-month-index="${index}" data-year="${year}"></span></td>`;
                        });
                    }
                    bodyHTML += `</tr>`;
                });
                targetTbody.innerHTML = bodyHTML;

            } catch (error) {
                targetTbody.innerHTML = `<tr><td colspan="13" class="text-center p-4 text-red-500">${error.message}</td></tr>`;
            } finally {
                hideLoader();
            }
        };

        const renderAdminDashboard = async () => {
            showLoader();
            const selectedMonth = parseInt(adminMonthSelector.value, 10);
            const selectedYear = adminYearSelector.value;
            
            await getAllSchoolData(); // Refresh data

            const completedListContainer = document.getElementById('admin-completed-school-list');
            const incompleteListContainer = document.getElementById('admin-incomplete-school-list');
            completedListContainer.innerHTML = '';
            incompleteListContainer.innerHTML = '';

            let completedCount = 0;
            let incompleteCount = 0;

            Object.keys(SCHOOL_DB).sort((a,b) => SCHOOL_DB[a].localeCompare(SCHOOL_DB[b])).forEach(schoolCode => {
                const schoolData = ALL_SCHOOL_DATA.find(d => d.school_code === schoolCode) || {};
                const activeUtilities = (schoolData.settings || []).filter(u => u.isActive);
                const bills = schoolData.bills || {};
                let isComplete = activeUtilities.length > 0;
                if(activeUtilities.length === 0) isComplete = true; 
                
                for (const util of activeUtilities) {
                    const billKey = `${selectedYear}-${util.utilityId}-${util.accountNumber}`;
                    const billData = (bills[billKey] && bills[billKey][selectedMonth]) ? bills[billKey][selectedMonth] : {};
                    if (!billData.amount || billData.amount <= 0) {
                        isComplete = false;
                        break;
                    }
                }
                
                const schoolCardHTML = `
                    <button class="w-full p-2.5 border rounded-lg text-left transition focus:outline-none focus:ring-2 focus:ring-indigo-500 ${isComplete ? 'bg-white border-slate-200 hover:bg-slate-50' : 'bg-orange-50 border-orange-200 hover:bg-orange-100'}" data-school-code="${schoolCode}">
                        <div class="flex items-center justify-between">
                            <p class="text-sm font-medium text-slate-800 truncate">${SCHOOL_DB[schoolCode]} <span class="text-xs font-normal text-slate-500">(${schoolCode})</span></p>
                            ${isComplete ? '<span class="flex-shrink-0 w-2.5 h-2.5 bg-green-500 rounded-full ml-2" title="Selesai"></span>' : ''}
                        </div>
                    </button>`;

                if (isComplete) {
                    completedListContainer.innerHTML += schoolCardHTML;
                    completedCount++;
                } else {
                    incompleteListContainer.innerHTML += schoolCardHTML;
                    incompleteCount++;
                }
            });

            if (completedCount === 0) completedListContainer.innerHTML = `<div class="border-2 border-dashed border-slate-200 rounded-lg p-6 text-center text-slate-500"><p>Tiada sekolah yang telah selesai.</p></div>`;
            if (incompleteCount === 0) incompleteListContainer.innerHTML = `<div class="border-2 border-dashed border-green-200 rounded-lg p-6 text-center text-green-600"><p class="font-semibold">Hebat!</p><p>Semua sekolah telah selesai.</p></div>`;

            const adminSummaryTableHead = document.querySelector('#admin-summary-status-section thead');
            adminSummaryTableHead.innerHTML = `<tr><th class="px-4 py-3">Nama Sekolah</th>${MONTHS.map(m => `<th class="px-4 py-3 text-center">${m.substring(0,3)}</th>`).join('')}</tr>`;
            await renderSchoolStatusTable(adminSummaryStatusTbody, selectedYear);
            hideLoader();
        };
        
        // --- Pengendali Acara (Event Handlers) ---
        verifyButton.addEventListener('click', async () => {
            const code = schoolCodeInput.value.trim().toUpperCase();
            if (!code) return showToast('Sila masukkan Kod Sekolah.', true);
            if (!SCHOOL_DB[code]) return showToast('Kod sekolah tidak sah. Sila hubungi admin.', true);

            sessionStorage.setItem('myutiliti_currentSchoolCode', code);
            
            showLoader();
            const { settings } = await getSchoolData(code);
            hideLoader();

            if (settings && settings.length > 0) {
                await renderDashboard();
                showPage('dashboard');
            } else {
                await renderSetupPage();
                showPage('setup');
            }
        });

        saveSetupButton.addEventListener('click', async () => {
            const schoolCode = sessionStorage.getItem('myutiliti_currentSchoolCode');
            const allUtilities = [];
            document.querySelectorAll('#utility-list .flex.items-center.gap-3').forEach(row => {
                const accountNumber = row.querySelector('.account-number-input').value.trim();
                if (accountNumber) {
                    const utilityId = row.closest('.p-4.border').querySelector('.add-account-btn').dataset.utilityId;
                    allUtilities.push({
                        utilityId: utilityId,
                        accountNumber: accountNumber,
                        isActive: row.querySelector('.account-active-checkbox').checked
                    });
                }
            });

            if (await saveData(schoolCode, { settings: allUtilities })) {
                showToast('Tetapan utiliti berjaya disimpan!');
                await renderDashboard();
                showPage('dashboard');
            }
        });

        saveBillsButton.addEventListener('click', async () => {
            const schoolCode = sessionStorage.getItem('myutiliti_currentSchoolCode');
            const { bills } = await getSchoolData(schoolCode); // Dapatkan data bil sedia ada
            
            document.querySelectorAll('.bill-input').forEach(input => {
                const key = input.dataset.key;
                const monthIndex = parseInt(input.dataset.monthIndex, 10);
                if (!bills[key]) bills[key] = Array(12).fill({}).map(() => ({ amount: '', file: '', verifiedBy: '', verifiedAt: '' }));
                bills[key][monthIndex].amount = input.value;
            });

             if(await saveData(schoolCode, { bills: bills })) {
                showToast('Rekod bil berjaya disimpan!');
                await renderDashboard(); // Muat semula untuk papar data terkini
             }
        });

        // --- Inisialisasi Aplikasi ---
        const initializeApp = async () => {
            showLoader();
            try {
                await loadSchoolDB();
                populateYearSelectors([yearSelector, statusYearSelector, adminYearSelector]);
                
                if (sessionStorage.getItem('myutiliti_isAdmin') === 'true') {
                    populateAdminFilterSelectors();
                    await renderAdminDashboard();
                    showPage('adminDashboard');
                } else {
                    const currentSchoolCode = sessionStorage.getItem('myutiliti_currentSchoolCode');
                    const mainStatusThead = document.querySelector('#school-status-section thead');
                    mainStatusThead.innerHTML = `<tr><th class="px-4 py-3">Nama Sekolah</th>${MONTHS.map(m => `<th class="px-4 py-3 text-center">${m.substring(0,3)}</th>`).join('')}</tr>`;
                    await renderSchoolStatusTable(schoolStatusTbody, statusYearSelector.value);

                    if (!currentSchoolCode) {
                        showPage('verification');
                    } else {
                        await renderDashboard();
                        showPage('dashboard');
                    }
                }
            } catch (error) {
                alert(error.message);
                document.body.innerHTML = `<div class="text-center text-red-600">${error.message}</div>`;
            } finally {
                hideLoader();
            }
        };

        initializeApp();

        // Tambah semua event listener lain di sini
        // (logout, edit settings, admin login, etc.)
        // Pastikan fungsi yang dipanggil adalah 'async' jika ia berurusan dengan Supabase
        logoutButton.addEventListener('click', () => {
            sessionStorage.removeItem('myutiliti_currentSchoolCode');
            location.reload();
        });

        editSettingsButton.addEventListener('click', async () => {
            await renderSetupPage();
            showPage('setup');
        });

        yearSelector.addEventListener('change', renderDashboard);
        statusYearSelector.addEventListener('change', (e) => renderSchoolStatusTable(schoolStatusTbody, e.target.value));

    });
</script>

</body>
</html>

